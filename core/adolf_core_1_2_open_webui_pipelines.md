---
title: "–†–∞–∑–¥–µ–ª 1.2: Open Webui Pipelines"
mode: "wide"
---

**–ü—Ä–æ–µ–∫—Ç:** –Ø–¥—Ä–æ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π AI-—Å–∏—Å—Ç–µ–º—ã  
**–ú–æ–¥—É–ª—å:** User Interface  
**–í–µ—Ä—Å–∏—è:** 4.1  
**–î–∞—Ç–∞:** –Ø–Ω–≤–∞—Ä—å 2026

---

## 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

### 4.1. –ü—É–Ω–∫—Ç—ã –º–µ–Ω—é

| –ü—É–Ω–∫—Ç –º–µ–Ω—é | –ò–∫–æ–Ω–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------|--------|----------|
| –ß–∞—Ç | üí¨ | –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º |
| –î–æ–±–∞–≤–∏—Ç—å –≤ KB | üì§ | –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π |
| –ú–æ–¥–µ—Ä–∞—Ü–∏—è KB | üìã | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ |
| –û—Ç–∑—ã–≤—ã | ‚≠ê | –†–∞–±–æ—Ç–∞ —Å –æ—Ç–∑—ã–≤–∞–º–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω | üîç | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Ü–µ–Ω –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | üìä | –û—Ç—á—ë—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ |
| –§–∏–Ω–∞–Ω—Å—ã | üí∞ | –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ |
| –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ | üìà | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã |
| –ù–∞—Å—Ç—Ä–æ–π–∫–∏ | ‚öôÔ∏è | –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ |

**(N)** ‚Äî —Å—á—ë—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —É –ø—É–Ω–∫—Ç–æ–≤ –ú–æ–¥–µ—Ä–∞—Ü–∏—è KB –∏ –û—Ç–∑—ã–≤—ã.

### 4.2. –ú–∞—Ç—Ä–∏—Ü–∞ –¥–æ—Å—Ç—É–ø–∞ –ø–æ —Ä–æ–ª—è–º

| –ü—É–Ω–∫—Ç –º–µ–Ω—é | Staff | Manager | Senior | Director | Admin |
|------------|:-----:|:-------:|:------:|:--------:|:-----:|
| –ß–∞—Ç | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| –î–æ–±–∞–≤–∏—Ç—å –≤ KB | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| –ú–æ–¥–µ—Ä–∞—Ü–∏—è KB | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ |
| –û—Ç–∑—ã–≤—ã | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ | ‚ùå | –ë–∞–∑–æ–≤–∞—è | –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è | –ü–æ–ª–Ω–∞—è | ‚úÖ |
| –§–∏–Ω–∞–Ω—Å—ã | ‚ùå | ‚ùå | –ë–∞–∑–æ–≤–∞—è | –ü–æ–ª–Ω–∞—è | ‚úÖ |
| –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ | ‚ùå | ‚ùå | –ë–∞–∑–æ–≤–∞—è | –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è | –ü–æ–ª–Ω–∞—è |
| –ù–∞—Å—Ç—Ä–æ–π–∫–∏ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚úÖ |

### 4.3. –°—Ö–µ–º–∞ –¥–æ—Å—Ç—É–ø–∞

```mermaid
flowchart TB
    subgraph ROLES["–†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"]
        STAFF["Staff"]
        MNG["Manager"]
        SNR["Senior"]
        DIR["Director"]
        ADM["Administrator"]
    end
    
    subgraph ACCESS["–£—Ä–æ–≤–Ω–∏ –¥–æ—Å—Ç—É–ø–∞"]
        L1["–ë–∞–∑–æ–≤—ã–π<br/>(–ß–∞—Ç)"]
        L2["–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π<br/>(–û—Ç–∑—ã–≤—ã, –¶–µ–Ω—ã)"]
        L3["–£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π<br/>(–ú–æ–¥–µ—Ä–∞—Ü–∏—è, –ê–Ω–∞–ª–∏—Ç–∏–∫–∞)"]
        L4["–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π<br/>(–§–∏–Ω–∞–Ω—Å—ã, –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)"]
        L5["–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π<br/>(–ù–∞—Å—Ç—Ä–æ–π–∫–∏)"]
    end
    
    STAFF --> L1
    MNG --> L1 & L2
    SNR --> L1 & L2 & L3 & L4
    DIR --> L1 & L2 & L3 & L4
    ADM --> L1 & L2 & L3 & L4 & L5
```

### 4.4. Pipelines ‚Äî –∞–≥–µ–Ω—Ç—ã –º–æ–¥—É–ª–µ–π

–ö–∞–∂–¥—ã–π –º–æ–¥—É–ª—å —Å–∏—Å—Ç–µ–º—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–º Pipeline:

| Pipeline | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ä–æ–ª—å |
|----------|------------|------------------|
| `@Adolf` | –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç, –∞–≤—Ç–æ–≤—ã–±–æ—Ä –º–æ–¥—É–ª—è | staff |
| `@Adolf_KB` | –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | manager |
| `@Adolf_Moderation` | –ú–æ–¥–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ | senior |
| `@Adolf_Reviews` | –†–∞–±–æ—Ç–∞ —Å –æ—Ç–∑—ã–≤–∞–º–∏ | manager |
| `@Adolf_Prices` | –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω | manager |
| `@Adolf_Analytics` | –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã | manager |
| `@Adolf_Finance` | –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ—Ç—á—ë—Ç—ã | senior |
| `@Adolf_Stats` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã | senior |
| `@Adolf_Settings` | –°–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ | administrator |

---

## 5. Pipelines

### 5.1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Pipeline

```mermaid
flowchart LR
    INPUT["User Message"]
    
    subgraph PIPELINE["Pipeline"]
        INLET["Inlet<br/>(Preprocessing)"]
        PIPE["Pipe<br/>(Main Logic)"]
        OUTLET["Outlet<br/>(Postprocessing)"]
    end
    
    VALVES["Valves<br/>(Settings)"]
    TOOLS["Tools"]
    OUTPUT["Response"]
    
    INPUT --> INLET
    INLET --> PIPE
    PIPE <--> TOOLS
    PIPE --> OUTLET
    OUTLET --> OUTPUT
    VALVES --> PIPE
```

### 5.2. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞–ø—Ä–æ—Å–∞

```mermaid
sequenceDiagram
    participant U as User
    participant I as Inlet
    participant P as Pipe
    participant T as Tools
    participant O as Outlet
    
    U->>I: –°–æ–æ–±—â–µ–Ω–∏–µ
    I->>I: Preprocessing
    I->>P: –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    
    P->>T: Tool call
    T-->>P: Result
    
    P->>O: –û—Ç–≤–µ—Ç
    O->>O: Postprocessing
    O-->>U: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
```

### 5.3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
/app/backend/pipelines/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ adolf_main.py           # –û—Å–Ω–æ–≤–Ω–æ–π Pipeline
‚îú‚îÄ‚îÄ adolf_kb.py             # –ó–∞–≥—Ä—É–∑–∫–∞ –≤ KB
‚îú‚îÄ‚îÄ adolf_moderation.py     # –ú–æ–¥–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚îú‚îÄ‚îÄ adolf_reviews.py        # –†–∞–±–æ—Ç–∞ —Å –æ—Ç–∑—ã–≤–∞–º–∏
‚îú‚îÄ‚îÄ adolf_prices.py         # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω
‚îú‚îÄ‚îÄ adolf_analytics.py      # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
‚îú‚îÄ‚îÄ adolf_finance.py        # –§–∏–Ω–∞–Ω—Å—ã
‚îú‚îÄ‚îÄ adolf_stats.py          # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
‚îî‚îÄ‚îÄ adolf_settings.py       # –ù–∞—Å—Ç—Ä–æ–π–∫–∏
```

### 5.4. –û—Å–Ω–æ–≤–Ω–æ–π Pipeline (@Adolf)

```python
# pipelines/adolf_main.py
"""
title: Adolf Main Pipeline
author: Adolf Team
version: 1.0.0
"""

from typing import List, Generator
from pydantic import BaseModel, Field
import requests


class Valves(BaseModel):
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Pipeline."""
    
    MIDDLEWARE_URL: str = Field(
        default="http://middleware:8000",
        description="URL Middleware API"
    )
    MIDDLEWARE_API_KEY: str = Field(
        default="",
        description="API –∫–ª—é—á Middleware"
    )
    DEFAULT_MODEL: str = Field(
        default="gpt-4o-mini",
        description="–ú–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"
    )


class Pipeline:
    """–û—Å–Ω–æ–≤–Ω–æ–π Pipeline —Å–∏—Å—Ç–µ–º—ã Adolf."""
    
    def __init__(self):
        self.name = "Adolf"
        self.valves = Valves()
    
    async def on_startup(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ."""
        print(f"Adolf Pipeline started. Middleware: {self.valves.MIDDLEWARE_URL}")
    
    async def on_shutdown(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ."""
        print("Adolf Pipeline stopped.")
    
    def pipe(
        self,
        body: dict,
        __user__: dict,
        __event_emitter__: callable = None
    ) -> Generator:
        """
        –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏.
        
        Args:
            body: –¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ (messages, model, etc.)
            __user__: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            __event_emitter__: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π
        """
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        user_id = __user__.get("id")
        user_role = __user__.get("role", "staff")
        user_brand = __user__.get("valves", {}).get("brand_id", "all")
        
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ system message
        system_context = self._build_system_context(user_role, user_brand)
        
        messages = body.get("messages", [])
        if messages and messages[0].get("role") != "system":
            messages.insert(0, {"role": "system", "content": system_context})
        
        # –ó–∞–ø—Ä–æ—Å –∫ Middleware
        response = requests.post(
            f"{self.valves.MIDDLEWARE_URL}/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {self.valves.MIDDLEWARE_API_KEY}",
                "X-User-ID": str(user_id),
                "X-User-Role": user_role,
                "X-User-Brand": user_brand
            },
            json={
                "model": body.get("model", self.valves.DEFAULT_MODEL),
                "messages": messages,
                "stream": True,
                "tools": self._get_tools_for_role(user_role)
            },
            stream=True
        )
        
        # Streaming response
        for line in response.iter_lines():
            if line:
                yield line.decode("utf-8")
    
    def _build_system_context(self, role: str, brand: str) -> str:
        """–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞."""
        
        context = """–¢—ã ‚Äî Adolf, –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ –û—Ö–∞–Ω–∞ –ú–∞—Ä–∫–µ—Ç.

–¢–≤–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ü–æ–∏—Å–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π
- –†–∞–±–æ—Ç–∞ —Å –æ—Ç–∑—ã–≤–∞–º–∏ –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ü–µ–Ω –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤
- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã

–ü—Ä–∞–≤–∏–ª–∞:
- –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
- –ë—É–¥—å —Ç–æ—á–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º
- –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã (tools)
- –£–∫–∞–∑—ã–≤–∞–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
"""
        
        context += f"\n–¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: —Ä–æ–ª—å={role}, –±—Ä–µ–Ω–¥={brand}"
        
        return context
    
    def _get_tools_for_role(self, role: str) -> List[dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–æ–ª–∏."""
        
        base_tools = [
            {
                "type": "function",
                "function": {
                    "name": "knowledge_search",
                    "description": "–ü–æ–∏—Å–∫ –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "query": {
                                "type": "string",
                                "description": "–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å"
                            }
                        },
                        "required": ["query"]
                    }
                }
            }
        ]
        
        manager_tools = [
            {
                "type": "function",
                "function": {
                    "name": "reviews_list",
                    "description": "–°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "platform": {
                                "type": "string",
                                "enum": ["wb", "ozon"]
                            },
                            "status": {
                                "type": "string",
                                "enum": ["new", "pending"]
                            }
                        }
                    }
                }
            },
            {
                "type": "function",
                "function": {
                    "name": "price_check",
                    "description": "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–Ω –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "sku": {
                                "type": "string",
                                "description": "–ê—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞"
                            }
                        },
                        "required": ["sku"]
                    }
                }
            }
        ]
        
        tools = base_tools.copy()
        
        if role in ("manager", "senior", "director", "administrator"):
            tools.extend(manager_tools)
        
        return tools
```

### 5.5. Pipeline –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–∑—ã–≤–∞–º–∏

```python
# pipelines/adolf_reviews.py
"""
title: Adolf Reviews Pipeline
author: Adolf Team
version: 1.0.0
"""

from typing import List, Generator
from pydantic import BaseModel, Field
import requests


class Valves(BaseModel):
    MIDDLEWARE_URL: str = Field(default="http://middleware:8000")
    MIDDLEWARE_API_KEY: str = Field(default="")


class Pipeline:
    """Pipeline –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–∑—ã–≤–∞–º–∏ –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏."""
    
    def __init__(self):
        self.name = "Adolf Reviews"
        self.valves = Valves()
    
    def inlet(self, body: dict, __user__: dict) -> dict:
        """Preprocessing ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ–± –æ—Ç–∑—ã–≤–∞—Ö."""
        
        user_role = __user__.get("role", "staff")
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
        if user_role == "staff":
            body["messages"].append({
                "role": "system",
                "content": "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–æ–¥—É–ª—é –æ—Ç–∑—ã–≤–æ–≤."
            })
            return body
        
        # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤
        reviews = self._fetch_pending_reviews(__user__)
        
        if reviews:
            context = f"–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö –æ—Ç–∑—ã–≤–æ–≤: {len(reviews)}\n\n"
            for r in reviews[:5]:
                context += f"- {r['platform']}: {r['rating']}‚≠ê –æ—Ç {r['client_name']}\n"
            
            body["messages"].insert(0, {
                "role": "system",
                "content": context
            })
        
        return body
    
    def pipe(self, body: dict, __user__: dict) -> Generator:
        """–û—Å–Ω–æ–≤–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞."""
        
        response = requests.post(
            f"{self.valves.MIDDLEWARE_URL}/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {self.valves.MIDDLEWARE_API_KEY}",
                "X-User-ID": str(__user__.get("id")),
                "X-User-Role": __user__.get("role"),
                "X-User-Brand": __user__.get("valves", {}).get("brand_id", "all")
            },
            json={
                "model": "gpt-4o-mini",
                "messages": body.get("messages", []),
                "stream": True,
                "tools": self._get_review_tools()
            },
            stream=True
        )
        
        for line in response.iter_lines():
            if line:
                yield line.decode("utf-8")
    
    def outlet(self, body: dict, __user__: dict) -> dict:
        """Postprocessing ‚Äî —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –æ—Ç–∑—ã–≤–æ–≤."""
        return body
    
    def _fetch_pending_reviews(self, user: dict) -> List[dict]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é."""
        
        try:
            response = requests.get(
                f"{self.valves.MIDDLEWARE_URL}/api/v1/reviews",
                headers={
                    "Authorization": f"Bearer {self.valves.MIDDLEWARE_API_KEY}",
                    "X-User-ID": str(user.get("id")),
                    "X-User-Role": user.get("role"),
                    "X-User-Brand": user.get("valves", {}).get("brand_id", "all")
                },
                params={"status": "new", "limit": 10}
            )
            return response.json()
        except Exception:
            return []
    
    def _get_review_tools(self) -> List[dict]:
        """–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–∑—ã–≤–∞–º–∏."""
        
        return [
            {
                "type": "function",
                "function": {
                    "name": "reviews_list",
                    "description": "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "platform": {
                                "type": "string",
                                "enum": ["wb", "ozon", "all"],
                                "description": "–ü–ª–æ—â–∞–¥–∫–∞"
                            },
                            "status": {
                                "type": "string",
                                "enum": ["new", "pending", "all"],
                                "description": "–°—Ç–∞—Ç—É—Å"
                            },
                            "rating": {
                                "type": "integer",
                                "minimum": 1,
                                "maximum": 5,
                                "description": "–§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É"
                            }
                        }
                    }
                }
            },
            {
                "type": "function",
                "function": {
                    "name": "review_approve",
                    "description": "–£—Ç–≤–µ—Ä–¥–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–∑—ã–≤",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "review_id": {
                                "type": "integer",
                                "description": "ID –æ—Ç–∑—ã–≤–∞"
                            }
                        },
                        "required": ["review_id"]
                    }
                }
            },
            {
                "type": "function",
                "function": {
                    "name": "review_edit",
                    "description": "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–∑—ã–≤",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "review_id": {
                                "type": "integer",
                                "description": "ID –æ—Ç–∑—ã–≤–∞"
                            },
                            "new_response": {
                                "type": "string",
                                "description": "–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞"
                            }
                        },
                        "required": ["review_id", "new_response"]
                    }
                }
            },
            {
                "type": "function",
                "function": {
                    "name": "review_generate",
                    "description": "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ –æ—Ç–∑—ã–≤",
                    "parameters": {
                        "type": "object",
                        "properties": {
                            "review_id": {
                                "type": "integer",
                                "description": "ID –æ—Ç–∑—ã–≤–∞"
                            },
                            "tone": {
                                "type": "string",
                                "enum": ["formal", "friendly", "apologetic"],
                                "description": "–¢–æ–Ω –æ—Ç–≤–µ—Ç–∞"
                            }
                        },
                        "required": ["review_id"]
                    }
                }
            }
        ]
```

---

**–ö–æ–Ω–µ—Ü —á–∞—Å—Ç–∏ 1.2**

**–°–ª–µ–¥—É—é—â–∞—è —á–∞—Å—Ç—å:** 1.3 ‚Äî Tools
