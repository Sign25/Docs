---
title: "–†–∞–∑–¥–µ–ª 4: –ù–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏—è"
mode: "wide"
---

**–ü—Ä–æ–µ–∫—Ç:** –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–∏—Å—Ç–∏–∫–æ–π –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤  
**–ú–æ–¥—É–ª—å:** Logistic / Supply Task Engine  
**–í–µ—Ä—Å–∏—è:** 2.0  
**–î–∞—Ç–∞:** –§–µ–≤—Ä–∞–ª—å 2026  
**–ó–∞–º–µ–Ω—è–µ—Ç:** adolf_logistic_4_order_analyzer_v1_0.md

---

## 4.1 –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

### –û–ø–∏—Å–∞–Ω–∏–µ

Supply Task Engine ‚Äî –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–æ–¥—É–ª—è Logistic, –æ—Ç–≤–µ—á–∞—é—â–∏–π –∑–∞:
- –†–∞—Å—á—ë—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –ø–æ –∫–∞–∂–¥–æ–º—É SKU √ó –∫–ª–∞—Å—Ç–µ—Ä Ozon
- –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–π –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É FBO
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –∑–∞–¥–∞–Ω–∏–π (–ù–æ–≤—ã–π ‚Üí –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω ‚Üí –°–æ–±—Ä–∞–Ω ‚Üí –û—Ç–≥—Ä—É–∂–µ–Ω)
- –ü—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ª–∏—á–∏—è —Ç–æ–≤–∞—Ä–∞ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º —Å–∫–ª–∞–¥–µ (1–°)
- –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—é –æ—Ç–≥—Ä—É–∑–æ–∫ –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏

### –û—Ç–ª–∏—á–∏–µ –æ—Ç Order Analyzer v1.0

| –ü–∞—Ä–∞–º–µ—Ç—Ä | v1.0 (Order Analyzer) | v2.0 (Supply Task Engine) |
|----------|----------------------|--------------------------|
| –ó–∞–¥–∞—á–∞ | –ü–æ—Å—Ç—Ñ–∞–∫—Ç—É–º-–∞–Ω–∞–ª–∏–∑ –∫—Ä–æ—Å—Å-–¥–æ–∫–∏–Ω–≥–∞ WB | –ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É |
| –í—Ö–æ–¥ | –ó–∞–∫–∞–∑—ã WB (—É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ) | –û—Å—Ç–∞—Ç–∫–∏ FBO + –ø—Ä–æ–≥–Ω–æ–∑ + 1–° |
| –í—ã—Ö–æ–¥ | –û—Ç—á—ë—Ç –ø–æ —É–±—ã—Ç–∫–∞–º | –ò—Å–ø–æ–ª–Ω—è–µ–º–æ–µ –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–µ |
| –ü–æ–¥—Ö–æ–¥ | –†–µ–∞–∫—Ç–∏–≤–Ω—ã–π (–æ–±–Ω–∞—Ä—É–∂–∏–ª ‚Üí –∞–ª–µ—Ä—Ç) | –ü—Ä–æ–∞–∫—Ç–∏–≤–Ω—ã–π (—Å–ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–ª ‚Üí –∑–∞–¥–∞–Ω–∏–µ) |
| –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å | Wildberries | Ozon (31 –∫–ª–∞—Å—Ç–µ—Ä FBO) |

### –û–±—â–∏–π –ø–æ—Ç–æ–∫

```mermaid
flowchart TD
    subgraph INPUT["–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"]
        STOCK_MON["Stock Monitor<br/>–æ—Å—Ç–∞—Ç–∫–∏ FBO –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º"]
        FORECAST["DemandForecaster<br/>–ø—Ä–æ–≥–Ω–æ–∑ —Å–ø—Ä–æ—Å–∞ 14 –¥–Ω."]
        ONE_C["1–° Import<br/>–æ—Å—Ç–∞—Ç–∫–∏ –≤–Ω—É—Ç—Ä. —Å–∫–ª–∞–¥–∞"]
    end
    
    subgraph ENGINE["Supply Task Engine"]
        CALC["SupplyCalculator<br/>deficit = forecast ‚àí FBO ‚àí in_transit"]
        CHECK_WH{"–ï—Å—Ç—å –Ω–∞<br/>—Å–∫–ª–∞–¥–µ 1–°?"}
        PRIORITY["–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è:<br/>urgent / planned / recommended"]
        GEN["TaskGenerator<br/>—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è"]
        ALERT_PURCHASE["‚ö† PURCHASE_REQUIRED<br/>(–Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ)"]
    end
    
    subgraph LIFECYCLE["–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª"]
        NEW["üìã –ù–æ–≤—ã–π"]
        CONFIRMED["‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω"]
        COLLECTED["üì¶ –°–æ–±—Ä–∞–Ω"]
        SHIPPED["üöõ –û—Ç–≥—Ä—É–∂–µ–Ω"]
        CANCELLED["‚ùå –û—Ç–º–µ–Ω—ë–Ω"]
    end
    
    STOCK_MON & FORECAST --> CALC
    ONE_C --> CHECK_WH
    
    CALC --> CHECK_WH
    CHECK_WH -->|–î–∞| PRIORITY --> GEN
    CHECK_WH -->|–ù–µ—Ç| ALERT_PURCHASE
    
    GEN --> NEW
    NEW --> CONFIRMED --> COLLECTED --> SHIPPED
    NEW -->|48—á –±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è| CANCELLED
```

---

## 4.2 –†–∞—Å—á—ë—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞ (SupplyCalculator)

### –§–æ—Ä–º—É–ª–∞

```
deficit = max(0, target_stock ‚àí fbo_stock ‚àí in_transit)

target_stock = avg_daily_demand √ó horizon_days √ó safety_factor
```

–ì–¥–µ:
- `avg_daily_demand` ‚Äî —Å—Ä–µ–¥–Ω–∏–π —Å–ø—Ä–æ—Å –∏–∑ Stock Monitor (Ozon –∏–ª–∏ WMA)
- `horizon_days` ‚Äî –≥–æ—Ä–∏–∑–æ–Ω—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ (default: 14 –¥–Ω–µ–π)
- `safety_factor` ‚Äî –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–ø–∞—Å–∞ (default: 1.2)
- `fbo_stock` ‚Äî —Ç–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ FBO –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä–µ
- `in_transit` ‚Äî —Ç–æ–≤–∞—Ä –≤ –ø—É—Ç–∏ –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä

### –ê–ª–≥–æ—Ä–∏—Ç–º

```mermaid
flowchart TD
    START["–î–ª—è –∫–∞–∂–¥–æ–≥–æ<br/>article √ó cluster"]
    
    GET_VELOCITY["–ü–æ–ª—É—á–∏—Ç—å velocity<br/>(–∏–∑ Stock Monitor)"]
    
    CHECK_VEL{{"velocity > 0?"}}
    SKIP["–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å<br/>(–Ω–µ—Ç —Å–ø—Ä–æ—Å–∞)"]
    
    CALC_TARGET["target = velocity √ó 14 √ó 1.2"]
    GET_STOCK["fbo_stock + in_transit"]
    CALC_DEFICIT["deficit = target ‚àí available"]
    
    CHECK_DEFICIT{{"deficit > 0?"}}
    NO_DEFICIT["–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ<br/>–Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä–µ"]
    
    CHECK_1C{{"warehouse_stock<br/>>= deficit?"}}
    
    FULL["–ü–æ–ª–Ω—ã–π –æ–±—ä—ë–º:<br/>qty = deficit"]
    PARTIAL["–ß–∞—Å—Ç–∏—á–Ω—ã–π –æ–±—ä—ë–º:<br/>qty = warehouse_stock"]
    PURCHASE["‚ö† PURCHASE_REQUIRED"]
    
    START --> GET_VELOCITY --> CHECK_VEL
    CHECK_VEL -->|–ù–µ—Ç| SKIP
    CHECK_VEL -->|–î–∞| CALC_TARGET --> GET_STOCK --> CALC_DEFICIT --> CHECK_DEFICIT
    CHECK_DEFICIT -->|–ù–µ—Ç| NO_DEFICIT
    CHECK_DEFICIT -->|–î–∞| CHECK_1C
    CHECK_1C -->|–ü–æ–ª–Ω—ã–π| FULL
    CHECK_1C -->|–ß–∞—Å—Ç–∏—á–Ω—ã–π| PARTIAL
    CHECK_1C -->|–ù–µ—Ç| PURCHASE
```

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

```python
@dataclass
class DeficitResult:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á—ë—Ç–∞ –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –¥–ª—è SKU √ó –∫–ª–∞—Å—Ç–µ—Ä."""
    article: str
    ozon_sku: int
    product_name: str
    cluster_name: str
    
    # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    velocity_per_day: float
    fbo_stock: int
    in_transit: int
    days_to_zero: float | None
    
    # –†–∞—Å—á—ë—Ç
    target_stock: int       # —Ü–µ–ª–µ–≤–æ–π –∑–∞–ø–∞—Å
    available: int           # FBO + –≤ –ø—É—Ç–∏
    deficit: int             # –¥–µ—Ñ–∏—Ü–∏—Ç (—à—Ç)
    
    # –°–∫–ª–∞–¥ 1–°
    warehouse_stock: int     # –Ω–∞–ª–∏—á–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ
    supply_qty: int          # —Å–∫–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω–æ –æ—Ç–≥—Ä—É–∑–∏—Ç—å
    supply_coverage: str     # full / partial / none


class SupplyCalculator:
    """–†–∞—Å—á—ë—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –∏ –æ–±—ä—ë–º–∞ –ø–æ—Å—Ç–∞–≤–∫–∏."""
    
    def __init__(self, config: LogisticSettings):
        self.horizon = config.forecast_horizon_days   # 14
        self.safety = config.forecast_safety_factor    # 1.2
        self.min_stock = config.min_stock_threshold    # 5
    
    def calculate(
        self,
        article: str,
        ozon_sku: int,
        product_name: str,
        cluster_name: str,
        velocity_per_day: float,
        fbo_stock: int,
        in_transit: int,
        warehouse_stock: int,
        days_to_zero: float | None = None
    ) -> DeficitResult | None:
        """–†–∞—Å—á—ë—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ SKU √ó –∫–ª–∞—Å—Ç–µ—Ä."""
        
        if velocity_per_day <= 0:
            return None
        
        target = int(velocity_per_day * self.horizon * self.safety)
        target = max(target, self.min_stock)
        
        available = fbo_stock + in_transit
        deficit = max(0, target - available)
        
        if deficit == 0:
            return None
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –æ—Ç–≥—Ä—É–∑–∏—Ç—å
        if warehouse_stock >= deficit:
            supply_qty = deficit
            coverage = "full"
        elif warehouse_stock > 0:
            supply_qty = warehouse_stock
            coverage = "partial"
        else:
            supply_qty = 0
            coverage = "none"
        
        return DeficitResult(
            article=article,
            ozon_sku=ozon_sku,
            product_name=product_name,
            cluster_name=cluster_name,
            velocity_per_day=velocity_per_day,
            fbo_stock=fbo_stock,
            in_transit=in_transit,
            days_to_zero=days_to_zero,
            target_stock=target,
            available=available,
            deficit=deficit,
            warehouse_stock=warehouse_stock,
            supply_qty=supply_qty,
            supply_coverage=coverage
        )
```

---

## 4.3 –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö

### –ù–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–µ (SupplyTask)

```python
class TaskStatus(Enum):
    NEW = "new"                # –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ —Å–∏—Å—Ç–µ–º–æ–π
    CONFIRMED = "confirmed"    # –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª
    COLLECTED = "collected"    # –¢–æ–≤–∞—Ä —Å–æ–±—Ä–∞–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ
    SHIPPED = "shipped"        # –û—Ç–≥—Ä—É–∂–µ–Ω –≤ Ozon FBO
    CANCELLED = "cancelled"    # –û—Ç–º–µ–Ω–µ–Ω–æ


class TaskPriority(Enum):
    URGENT = "urgent"          # days_to_zero < 3
    PLANNED = "planned"        # days_to_zero < 7
    RECOMMENDED = "recommended" # days_to_zero >= 7


@dataclass
class SupplyTask:
    """–ù–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–µ –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É FBO."""
    id: UUID
    task_number: str            # LG-2026-02-06-001
    
    # –ß—Ç–æ –æ—Ç–≥—Ä—É–∑–∏—Ç—å
    article: str
    ozon_sku: int
    product_name: str
    quantity: int               # –æ–±—ä—ë–º –æ—Ç–≥—Ä—É–∑–∫–∏ (—à—Ç)
    
    # –ö—É–¥–∞
    cluster_name: str
    
    # –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    deficit: int                # —Ä–∞—Å—á—ë—Ç–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç
    velocity_per_day: float     # —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂
    days_to_zero: float | None  # –¥–Ω–µ–π –¥–æ –æ–±–Ω—É–ª–µ–Ω–∏—è
    fbo_stock: int              # —Ç–µ–∫—É—â–∏–π FBO
    warehouse_stock: int        # –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ 1–°
    supply_coverage: str        # full / partial
    
    # Workflow
    status: TaskStatus
    priority: TaskPriority
    brand_id: str
    
    # Timestamps
    created_at: datetime
    confirmed_at: datetime | None = None
    confirmed_by: str | None = None
    collected_at: datetime | None = None
    collected_by: str | None = None
    shipped_at: datetime | None = None
    shipped_by: str | None = None
    cancelled_at: datetime | None = None
    cancel_reason: str | None = None


@dataclass
class SupplyTaskBatch:
    """–ü–∞–∫–µ—Ç –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–π (–æ–¥–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è)."""
    batch_id: str               # batch_20260206_0700
    generated_at: datetime
    tasks: list[SupplyTask]
    
    # –ê–≥—Ä–µ–≥–∞—Ü–∏—è
    total_tasks: int
    total_quantity: int
    urgent_count: int
    planned_count: int
    recommended_count: int
    purchase_required_count: int  # –¥–µ—Ñ–∏—Ü–∏—Ç –±–µ–∑ –Ω–∞–ª–∏—á–∏—è –Ω–∞ —Å–∫–ª–∞–¥–µ
```

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

```mermaid
stateDiagram-v2
    [*] --> NEW: TaskGenerator —Å–æ–∑–¥–∞—ë—Ç
    
    NEW --> CONFIRMED: –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª
    NEW --> CANCELLED: –ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ (48—á)\n–∏–ª–∏ —Ä—É—á–Ω–∞—è –æ—Ç–º–µ–Ω–∞
    
    CONFIRMED --> COLLECTED: –¢–æ–≤–∞—Ä —Å–æ–±—Ä–∞–Ω
    CONFIRMED --> CANCELLED: –†—É—á–Ω–∞—è –æ—Ç–º–µ–Ω–∞
    
    COLLECTED --> SHIPPED: –û—Ç–≥—Ä—É–∂–µ–Ω –≤ Ozon FBO
    COLLECTED --> CANCELLED: –†—É—á–Ω–∞—è –æ—Ç–º–µ–Ω–∞
    
    SHIPPED --> [*]
    CANCELLED --> [*]
    
    NEW: üìã –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ —Å–∏—Å—Ç–µ–º–æ–π
    CONFIRMED: ‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª
    COLLECTED: üì¶ –¢–æ–≤–∞—Ä —Å–æ–±—Ä–∞–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ
    SHIPPED: üöõ –û—Ç–≥—Ä—É–∂–µ–Ω –≤ Ozon FBO
    CANCELLED: ‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ (–ø—Ä–∏—á–∏–Ω–∞)
```

---

## 4.4 –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏–π (TaskGenerator)

### –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å

```python
import structlog
from uuid import uuid4
from datetime import datetime, timedelta
from itertools import count

logger = structlog.get_logger("logistic.task_generator")


class TaskGenerator:
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–π –Ω–∞ –æ—Ç–≥—Ä—É–∑–∫—É FBO."""
    
    def __init__(
        self,
        calculator: SupplyCalculator,
        stock_repo: StockRepository,
        import_repo: ImportRepository,
        task_repo: SupplyTaskRepository,
        alert_service: AlertService,
        config: LogisticSettings
    ):
        self.calculator = calculator
        self.stock_repo = stock_repo
        self.import_repo = import_repo
        self.task_repo = task_repo
        self.alert_service = alert_service
        self.config = config
    
    async def generate_daily_tasks(self) -> SupplyTaskBatch:
        """
        –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–π.
        Celery task: 07:00.
        """
        logger.info("task_generation_started")
        
        # 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ FBO –ø–æ –∫–ª–∞—Å—Ç–µ—Ä–∞–º
        cluster_stocks = await self.stock_repo.get_latest_cluster_stocks()
        
        # 2. –ü–æ–ª—É—á–∞–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–∫–ª–∞–¥–∞ (1–°)
        warehouse_stocks = await self.import_repo.get_latest_stocks()
        wh_map = {ws.article: ws.warehouse_stock for ws in warehouse_stocks}
        
        # 3. –í—ã—á–∏—Ç–∞–µ–º —É–∂–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è–º–∏
        reserved = await self.task_repo.get_reserved_quantities()
        
        # 4. –†–∞—Å—á—ë—Ç –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤
        deficits: list[DeficitResult] = []
        purchase_required: list[dict] = []
        
        for cs in cluster_stocks:
            available_wh = wh_map.get(cs.article, 0) - reserved.get(cs.article, 0)
            available_wh = max(0, available_wh)
            
            result = self.calculator.calculate(
                article=cs.article,
                ozon_sku=cs.ozon_sku,
                product_name=cs.product_name,
                cluster_name=cs.cluster_name,
                velocity_per_day=cs.avg_daily_sales or 0,
                fbo_stock=cs.fbo_stock,
                in_transit=cs.in_transit,
                warehouse_stock=available_wh,
                days_to_zero=cs.days_to_zero
            )
            
            if result is None:
                continue
            
            if result.supply_coverage == "none":
                purchase_required.append({
                    "article": result.article,
                    "cluster": result.cluster_name,
                    "deficit": result.deficit
                })
            else:
                deficits.append(result)
        
        # 5. –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏—è
        tasks = self._create_tasks(deficits)
        
        # 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º
        if tasks:
            await self.task_repo.bulk_insert(tasks)
        
        # 7. –ê–ª–µ—Ä—Ç—ã –Ω–∞ –∑–∞–∫—É–ø–∫—É
        if purchase_required:
            await self._alert_purchase_required(purchase_required)
        
        batch = SupplyTaskBatch(
            batch_id=f"batch_{datetime.now().strftime('%Y%m%d_%H%M')}",
            generated_at=datetime.now(),
            tasks=tasks,
            total_tasks=len(tasks),
            total_quantity=sum(t.quantity for t in tasks),
            urgent_count=sum(1 for t in tasks if t.priority == TaskPriority.URGENT),
            planned_count=sum(1 for t in tasks if t.priority == TaskPriority.PLANNED),
            recommended_count=sum(1 for t in tasks if t.priority == TaskPriority.RECOMMENDED),
            purchase_required_count=len(purchase_required)
        )
        
        logger.info(
            "task_generation_completed",
            total_tasks=batch.total_tasks,
            total_qty=batch.total_quantity,
            urgent=batch.urgent_count,
            planned=batch.planned_count,
            recommended=batch.recommended_count,
            purchase_required=batch.purchase_required_count
        )
        
        return batch
    
    def _create_tasks(
        self, deficits: list[DeficitResult]
    ) -> list[SupplyTask]:
        """–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π –∏–∑ –¥–µ—Ñ–∏—Ü–∏—Ç–æ–≤."""
        tasks = []
        date_str = datetime.now().strftime("%Y-%m-%d")
        counter = count(1)
        
        # –°–æ—Ä—Ç–∏—Ä—É–µ–º: urgent –ø–µ—Ä–≤—ã–µ, –ø–æ—Ç–æ–º –ø–æ –¥–µ—Ñ–∏—Ü–∏—Ç—É
        deficits.sort(key=lambda d: (
            d.days_to_zero if d.days_to_zero else 999,
            -d.deficit
        ))
        
        for deficit in deficits:
            priority = self._determine_priority(deficit.days_to_zero)
            num = next(counter)
            
            task = SupplyTask(
                id=uuid4(),
                task_number=f"LG-{date_str}-{num:03d}",
                article=deficit.article,
                ozon_sku=deficit.ozon_sku,
                product_name=deficit.product_name,
                quantity=deficit.supply_qty,
                cluster_name=deficit.cluster_name,
                deficit=deficit.deficit,
                velocity_per_day=deficit.velocity_per_day,
                days_to_zero=deficit.days_to_zero,
                fbo_stock=deficit.fbo_stock,
                warehouse_stock=deficit.warehouse_stock,
                supply_coverage=deficit.supply_coverage,
                status=TaskStatus.NEW,
                priority=priority,
                brand_id=self._detect_brand(deficit.article),
                created_at=datetime.now()
            )
            tasks.append(task)
        
        return tasks
    
    def _determine_priority(self, days_to_zero: float | None) -> TaskPriority:
        if days_to_zero is None:
            return TaskPriority.RECOMMENDED
        if days_to_zero < self.config.critical_days_threshold:
            return TaskPriority.URGENT
        elif days_to_zero < self.config.warning_days_threshold:
            return TaskPriority.PLANNED
        return TaskPriority.RECOMMENDED
    
    async def _alert_purchase_required(self, items: list[dict]) -> None:
        """–ê–ª–µ—Ä—Ç: —Ç–æ–≤–∞—Ä–∞ –Ω–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ, –Ω—É–∂–Ω–∞ –∑–∞–∫—É–ø–∫–∞."""
        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É
        by_article: dict[str, int] = {}
        for item in items:
            by_article[item["article"]] = (
                by_article.get(item["article"], 0) + item["deficit"]
            )
        
        for article, total_deficit in by_article.items():
            await self.alert_service.create_alert(StockAlert(
                id=uuid4(),
                type=AlertType.WAREHOUSE_LOW,
                severity=AlertSeverity.HIGH,
                article=article,
                ozon_sku=None,
                cluster_name="ALL",
                message=f"–ù–µ—Ç –Ω–∞ —Å–∫–ª–∞–¥–µ: {article}, "
                        f"—Å—É–º–º–∞—Ä–Ω—ã–π –¥–µ—Ñ–∏—Ü–∏—Ç {total_deficit} —à—Ç",
                details={
                    "article": article,
                    "total_deficit": total_deficit,
                    "clusters": [i["cluster"] for i in items
                                 if i["article"] == article]
                },
                brand_id=self._detect_brand(article),
                created_at=datetime.now()
            ))
    
    def _detect_brand(self, article: str) -> str:
        """–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É."""
        # –ö–æ–Ω–≤–µ–Ω—Ü–∏—è: Kids-–∞—Ä—Ç–∏–∫—É–ª—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å 'K'
        return "ohana_kids" if article.startswith("K") else "ohana_market"
```

---

## 4.5 –°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è–º–∏ (SupplyTaskService)

### CRUD + Workflow

```python
class SupplyTaskService:
    """CRUD –∏ workflow –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–π."""
    
    def __init__(
        self,
        task_repo: SupplyTaskRepository,
        notify_service: NotificationService,
        config: LogisticSettings
    ):
        self.repo = task_repo
        self.notify = notify_service
        self.auto_cancel_hours = config.task_auto_cancel_hours  # 48
    
    # === –ó–∞–ø—Ä–æ—Å—ã ===
    
    async def get_tasks(
        self,
        date: datetime | None = None,
        status: TaskStatus | None = None,
        priority: TaskPriority | None = None,
        brand_id: str | None = None,
        limit: int = 100,
        offset: int = 0
    ) -> list[SupplyTask]:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏."""
        return await self.repo.get_tasks(
            date=date, status=status, priority=priority,
            brand_id=brand_id, limit=limit, offset=offset
        )
    
    async def get_task(self, task_id: UUID) -> SupplyTask:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ ID."""
        task = await self.repo.get_by_id(task_id)
        if not task:
            raise TaskNotFoundError(task_id)
        return task
    
    async def get_daily_summary(
        self, date: datetime | None = None, brand_id: str | None = None
    ) -> dict:
        """–°–≤–æ–¥–∫–∞ –∑–∞ –¥–µ–Ω—å."""
        target_date = date or datetime.now()
        tasks = await self.repo.get_tasks(date=target_date, brand_id=brand_id)
        
        return {
            "date": target_date.date().isoformat(),
            "total": len(tasks),
            "by_status": self._count_by(tasks, "status"),
            "by_priority": self._count_by(tasks, "priority"),
            "total_quantity": sum(t.quantity for t in tasks),
            "clusters": len(set(t.cluster_name for t in tasks)),
            "articles": len(set(t.article for t in tasks))
        }
    
    # === –ü–µ—Ä–µ—Ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤ ===
    
    VALID_TRANSITIONS: dict[TaskStatus, list[TaskStatus]] = {
        TaskStatus.NEW: [TaskStatus.CONFIRMED, TaskStatus.CANCELLED],
        TaskStatus.CONFIRMED: [TaskStatus.COLLECTED, TaskStatus.CANCELLED],
        TaskStatus.COLLECTED: [TaskStatus.SHIPPED, TaskStatus.CANCELLED],
        TaskStatus.SHIPPED: [],
        TaskStatus.CANCELLED: [],
    }
    
    async def confirm(self, task_id: UUID, user_id: str) -> SupplyTask:
        """–ú–µ–Ω–µ–¥–∂–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞–¥–∞–Ω–∏–µ."""
        task = await self.get_task(task_id)
        self._validate_transition(task.status, TaskStatus.CONFIRMED)
        
        task.status = TaskStatus.CONFIRMED
        task.confirmed_at = datetime.now()
        task.confirmed_by = user_id
        
        await self.repo.update(task)
        return task
    
    async def mark_collected(self, task_id: UUID, user_id: str) -> SupplyTask:
        """–¢–æ–≤–∞—Ä —Å–æ–±—Ä–∞–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ."""
        task = await self.get_task(task_id)
        self._validate_transition(task.status, TaskStatus.COLLECTED)
        
        task.status = TaskStatus.COLLECTED
        task.collected_at = datetime.now()
        task.collected_by = user_id
        
        await self.repo.update(task)
        return task
    
    async def mark_shipped(self, task_id: UUID, user_id: str) -> SupplyTask:
        """–û—Ç–≥—Ä—É–∂–µ–Ω –≤ Ozon FBO."""
        task = await self.get_task(task_id)
        self._validate_transition(task.status, TaskStatus.SHIPPED)
        
        task.status = TaskStatus.SHIPPED
        task.shipped_at = datetime.now()
        task.shipped_by = user_id
        
        await self.repo.update(task)
        await self.notify.send(
            f"‚úÖ –ó–∞–¥–∞–Ω–∏–µ {task.task_number} –æ—Ç–≥—Ä—É–∂–µ–Ω–æ: "
            f"{task.product_name} √ó {task.quantity} —à—Ç ‚Üí {task.cluster_name}"
        )
        return task
    
    async def cancel(
        self, task_id: UUID, reason: str, user_id: str | None = None
    ) -> SupplyTask:
        """–û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞–Ω–∏—è."""
        task = await self.get_task(task_id)
        self._validate_transition(task.status, TaskStatus.CANCELLED)
        
        task.status = TaskStatus.CANCELLED
        task.cancelled_at = datetime.now()
        task.cancel_reason = reason
        
        await self.repo.update(task)
        return task
    
    async def auto_cancel_expired(self) -> int:
        """–ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π (> 48—á)."""
        cutoff = datetime.now() - timedelta(hours=self.auto_cancel_hours)
        expired = await self.repo.get_expired_new_tasks(cutoff)
        
        for task in expired:
            task.status = TaskStatus.CANCELLED
            task.cancelled_at = datetime.now()
            task.cancel_reason = f"–ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞: –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ –∑–∞ {self.auto_cancel_hours}—á"
            await self.repo.update(task)
        
        if expired:
            logger.info("tasks_auto_cancelled", count=len(expired))
        
        return len(expired)
    
    def _validate_transition(
        self, current: TaskStatus, target: TaskStatus
    ) -> None:
        allowed = self.VALID_TRANSITIONS.get(current, [])
        if target not in allowed:
            raise InvalidStatusTransition(
                f"–ü–µ—Ä–µ—Ö–æ–¥ {current.value} ‚Üí {target.value} –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. "
                f"–î–æ–ø—É—Å—Ç–∏–º–æ: {[s.value for s in allowed]}"
            )
    
    def _count_by(self, tasks: list[SupplyTask], field: str) -> dict:
        result: dict[str, int] = {}
        for t in tasks:
            key = getattr(t, field)
            key = key.value if hasattr(key, 'value') else str(key)
            result[key] = result.get(key, 0) + 1
        return result
```

---

## 4.6 –ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏ —É—á—ë—Ç —Ä–µ–∑–µ—Ä–≤–∞

### –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤

–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—á–∏—Ç—ã–≤–∞—Ç—å —Ç–æ–≤–∞—Ä, —É–∂–µ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∑–∞–¥–∞–Ω–∏—è–º–∏, —á—Ç–æ–±—ã –Ω–µ —Å–æ–∑–¥–∞—Ç—å –¥–≤–æ–π–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è.

```python
class SupplyTaskRepository:
    """–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–π (—Ñ—Ä–∞–≥–º–µ–Ω—Ç)."""
    
    async def get_reserved_quantities(self) -> dict[str, int]:
        """
        –°—É–º–º–∞—Ä–Ω—ã–π –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—ä—ë–º –ø–æ –∞—Ä—Ç–∏–∫—É–ª–∞–º.
        
        –£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∑–∞–¥–∞–Ω–∏—è –≤ —Å—Ç–∞—Ç—É—Å–∞—Ö: NEW, CONFIRMED, COLLECTED.
        """
        query = """
            SELECT article, SUM(quantity) as reserved
            FROM supply_tasks
            WHERE status IN ('new', 'confirmed', 'collected')
            GROUP BY article
        """
        rows = await self.db.fetch_all(query)
        return {row["article"]: row["reserved"] for row in rows}
    
    async def get_expired_new_tasks(
        self, cutoff: datetime
    ) -> list[SupplyTask]:
        """–ù–µ–∑–∞–≤—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è —Å—Ç–∞—Ä—à–µ cutoff."""
        query = """
            SELECT * FROM supply_tasks
            WHERE status = 'new' AND created_at < :cutoff
        """
        return await self.db.fetch_all(query, {"cutoff": cutoff})
```

### –§–æ—Ä–º—É–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞

```
available_warehouse = warehouse_stock_1c ‚àí reserved_by_active_tasks

reserved = SUM(quantity) WHERE status IN (NEW, CONFIRMED, COLLECTED)
```

---

## 4.7 –ê–ª–µ—Ä—Ç—ã

### –¢–∏–ø—ã –∞–ª–µ—Ä—Ç–æ–≤ Supply Task Engine

| –¢–∏–ø | Severity | –¢—Ä–∏–≥–≥–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|---------|----------|
| `TASKS_GENERATED` | LOW | –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è | N –∑–∞–¥–∞–Ω–∏–π —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ |
| `WAREHOUSE_LOW` | HIGH | warehouse_stock = 0 –¥–ª—è –¥–µ—Ñ–∏—Ü–∏—Ç–Ω—ã—Ö SKU | –ù–µ—Ç —Ç–æ–≤–∞—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ, –Ω—É–∂–Ω–∞ –∑–∞–∫—É–ø–∫–∞ |
| `TASK_OVERDUE` | MEDIUM | NEW > 48—á | –ó–∞–¥–∞–Ω–∏–µ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ, –∞–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ |
| `PARTIAL_SUPPLY` | MEDIUM | coverage = partial | –ß–∞—Å—Ç–∏—á–Ω–∞—è –æ—Ç–≥—Ä—É–∑–∫–∞ (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥–µ) |

---

## 4.8 API Endpoints

### REST API

```python
router = APIRouter(prefix="/logistic/supply-tasks", tags=["Supply Tasks"])


@router.get("/")
async def list_supply_tasks(
    date: datetime | None = Query(None),
    status: str | None = Query(None),
    priority: str | None = Query(None),
    brand_id: str | None = Query(None),
    limit: int = Query(100, le=500),
    offset: int = Query(0),
    service: SupplyTaskService = Depends(get_task_service),
    current_user: User = Depends(get_current_user)
) -> list[SupplyTask]:
    """–°–ø–∏—Å–æ–∫ –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏."""
    return await service.get_tasks(
        date=date,
        status=TaskStatus(status) if status else None,
        priority=TaskPriority(priority) if priority else None,
        brand_id=brand_id or current_user.brand_id,
        limit=limit, offset=offset
    )


@router.get("/summary")
async def get_daily_summary(
    date: datetime | None = Query(None),
    brand_id: str | None = Query(None),
    service: SupplyTaskService = Depends(get_task_service),
    current_user: User = Depends(get_current_user)
) -> dict:
    """–°–≤–æ–¥–∫–∞ –∑–∞ –¥–µ–Ω—å: –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º, –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º, –æ–±—ä—ë–º–∞–º."""
    return await service.get_daily_summary(
        date=date,
        brand_id=brand_id or current_user.brand_id
    )


@router.get("/{task_id}")
async def get_supply_task(
    task_id: UUID,
    service: SupplyTaskService = Depends(get_task_service)
) -> SupplyTask:
    """–î–µ—Ç–∞–ª–∏ –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏—è."""
    return await service.get_task(task_id)


@router.patch("/{task_id}/confirm")
async def confirm_task(
    task_id: UUID,
    service: SupplyTaskService = Depends(get_task_service),
    current_user: User = Depends(get_current_user)
) -> SupplyTask:
    """–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ (NEW ‚Üí CONFIRMED)."""
    return await service.confirm(task_id, current_user.id)


@router.patch("/{task_id}/collected")
async def mark_collected(
    task_id: UUID,
    service: SupplyTaskService = Depends(get_task_service),
    current_user: User = Depends(get_current_user)
) -> SupplyTask:
    """–¢–æ–≤–∞—Ä —Å–æ–±—Ä–∞–Ω (CONFIRMED ‚Üí COLLECTED)."""
    return await service.mark_collected(task_id, current_user.id)


@router.patch("/{task_id}/shipped")
async def mark_shipped(
    task_id: UUID,
    service: SupplyTaskService = Depends(get_task_service),
    current_user: User = Depends(get_current_user)
) -> SupplyTask:
    """–û—Ç–≥—Ä—É–∂–µ–Ω (COLLECTED ‚Üí SHIPPED)."""
    return await service.mark_shipped(task_id, current_user.id)


@router.patch("/{task_id}/cancel")
async def cancel_task(
    task_id: UUID,
    reason: str = Query(..., min_length=3),
    service: SupplyTaskService = Depends(get_task_service),
    current_user: User = Depends(get_current_user)
) -> SupplyTask:
    """–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ (–ª—é–±–æ–π –∞–∫—Ç–∏–≤–Ω—ã–π ‚Üí CANCELLED)."""
    return await service.cancel(task_id, reason, current_user.id)


@router.post("/generate")
async def trigger_generation(
    service: SupplyTaskService = Depends(get_task_service),
    generator: TaskGenerator = Depends(get_task_generator),
    current_user: User = Depends(get_current_user)
) -> SupplyTaskBatch:
    """–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–≤–Ω–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)."""
    return await generator.generate_daily_tasks()
```

---

## 4.9 Celery Tasks

### –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏

```python
CELERY_BEAT_SCHEDULE = {
    "generate-supply-tasks-daily": {
        "task": "logistic.tasks.generate_supply_tasks",
        "schedule": crontab(hour=7, minute=0),
    },
    "auto-cancel-expired-tasks": {
        "task": "logistic.tasks.auto_cancel_expired",
        "schedule": crontab(hour="*/6"),  # –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
    },
}


@shared_task(bind=True, max_retries=2, default_retry_delay=600)
def generate_supply_tasks(self):
    """–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞—Ä—è–¥-–∑–∞–¥–∞–Ω–∏–π (07:00)."""
    import asyncio
    
    async def _generate():
        generator = get_task_generator()
        return await generator.generate_daily_tasks()
    
    batch = asyncio.run(_generate())
    
    return {
        "batch_id": batch.batch_id,
        "total_tasks": batch.total_tasks,
        "total_quantity": batch.total_quantity,
        "urgent": batch.urgent_count,
        "planned": batch.planned_count,
        "recommended": batch.recommended_count,
        "purchase_required": batch.purchase_required_count
    }


@shared_task
def auto_cancel_expired():
    """–ê–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π (–∫–∞–∂–¥—ã–µ 6—á)."""
    import asyncio
    
    async def _cancel():
        service = get_task_service()
        return await service.auto_cancel_expired()
    
    cancelled = asyncio.run(_cancel())
    return {"cancelled_count": cancelled}
```

---

## 4.10 –ü—Ä–æ–º–ø—Ç –¥–ª—è Claude Code

```
–†–µ–∞–ª–∏–∑—É–π Supply Task Engine –¥–ª—è –º–æ–¥—É–ª—è Logistic —Å–æ–≥–ª–∞—Å–Ω–æ 
adolf_logistic_4_supply_task_engine_v2_0.md

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
1. SupplyCalculator: deficit = (velocity √ó 14d √ó 1.2) ‚àí FBO ‚àí in_transit,
   –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–∞ —Å–∫–ª–∞–¥–µ 1–°, –ø–æ–∫—Ä—ã—Ç–∏–µ full/partial/none
2. TaskGenerator: –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, —É—á—ë—Ç –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ (active tasks),
   –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è urgent/planned/recommended, –Ω—É–º–µ—Ä–∞—Ü–∏—è LG-YYYY-MM-DD-NNN
3. SupplyTaskService: CRUD + workflow NEW‚ÜíCONFIRMED‚ÜíCOLLECTED‚ÜíSHIPPED‚ÜíCANCELLED,
   –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤, –∞–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ > 48—á
4. API: GET /supply-tasks (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏), GET /summary, 
   PATCH /{id}/confirm|collected|shipped|cancel, POST /generate
5. Celery: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è 07:00, –∞–≤—Ç–æ–æ—Ç–º–µ–Ω–∞ –∫–∞–∂–¥—ã–µ 6—á
6. –ê–ª–µ—Ä—Ç—ã: WAREHOUSE_LOW, TASK_OVERDUE, PARTIAL_SUPPLY

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: StockRepository (—Ä–∞–∑–¥–µ–ª 3), ImportRepository (—Ä–∞–∑–¥–µ–ª 5),
SupplyTaskRepository, AlertService, NotificationService
```

---

**–î–æ–∫—É–º–µ–Ω—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:** –§–µ–≤—Ä–∞–ª—å 2026  
**–í–µ—Ä—Å–∏—è:** 2.0  
**–°—Ç–∞—Ç—É—Å:** –ß–µ—Ä–Ω–æ–≤–∏–∫  
**–ó–∞–º–µ–Ω—è–µ—Ç:** adolf_logistic_4_order_analyzer_v1_0.md
